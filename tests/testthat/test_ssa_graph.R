context("SSA graph")

test_that("nodes are added for defs", {
  exp = quote(
    x <- 1
  )

  cfg = to_cfg(exp)
  ssa = cfg$ssa

  # -----
  expect_is(ssa[["x_1"]], "Assign")
})


test_that("nodes are added for uses", {
  exp = quote(
    mean(x)
  )

  cfg = to_cfg(exp, insert_return = FALSE)
  ssa = cfg$ssa

  # -----
  expect_is(ssa[["%1"]], "Call")
})


test_that("nodes are added for for-loop variables", {
  exp = quote({
    x = c(1, 2, 3)
    y = 0
    for (i in x) {
      y = y + i
    }
    return (y) # should be y_3
  })

  cfg = to_cfg(exp)
  ssa = cfg$ssa

  # -----
  expect_true(all(c("x_1", "y_1", "i_1", "y_2", "y_3") %in% names(ssa)))
  expect_is(ssa[["i_1"]], "For")
})


test_that("edges are added for defs that are also uses", {
  # There should be a link in the SSA graph from x_1 to y_1
  exp = quote({
    x = 1
    y = x
    # FIXME:
    # return (x)
  })

  cfg = to_cfg(exp)
  ssa = cfg$ssa

  # -----
  expect_is(ssa[["x_1"]], "Assign")
  expect_is(ssa[["y_1"]], "Assign")

  expect_true(ssa$graph[from = "x_1", to = "y_1"] == 1)
})


test_that("nodes are added for uses that are not defs", {
  exp = quote({
    x <- 1
    foo(x)
  })

  cfg = to_cfg(exp, insert_return = FALSE)
  ssa = cfg$ssa

  # -----
  expect_is(ssa[["x_1"]], "Assign")
  expect_is(ssa[["%1"]], "Call")

  expect_true(ssa$graph[from = "x_1", to = "%1"] == 1)
})


test_that("nodes and edges are added for phi-functions", {
  exp = quote({
    if (TRUE)
      x = 1
    else
      x = 2
    y = x
  })

  cfg = to_cfg(exp)
  ssa = cfg$ssa

  # -----
  expect_is(ssa[["x_1"]], "Assign")
  expect_is(ssa[["x_2"]], "Assign")
  expect_is(ssa[["x_3"]], "Phi")
  expect_is(ssa[["y_1"]], "Assign")

  expect_true(ssa$graph[from = "x_1", to = "x_3"] == 1)
  expect_true(ssa$graph[from = "x_2", to = "x_3"] == 1)
  expect_true(ssa$graph[from = "x_3", to = "y_1"] == 1)
})


#test_that("backedges are added for phi-functions", {
#  exp = quote(
#    for (i in 1:10)
#      x = 12
#  )
#
#  cfg = to_cfg(exp, insert_return = FALSE)
#  ssa = cfg$ssa
#
#  # -----
#  expect_true(ssa$graph[from = "._counter_i_2", to = "._counter_i_3"] == 1)
#  expect_true(ssa$graph[from = "._counter_i_3", to = "._counter_i_2"] == 1)
#})


test_that("nodes and edges are added for parameters", {
  fn = function(x) {
    y = x
  }

  cfg = to_cfg(fn)
  ssa = cfg$ssa

  # -----
  expect_is(ssa[["x_1"]], "Parameter")
  expect_is(ssa[["y_1"]], "Assign")

  expect_true(ssa$graph[from = "x_1", to = "y_1"] == 1)
})


test_that("globals", {
  exp = quote(y <- x)

  # FIXME:
  #cfg = to_cfg(fn)
  #ssa = cfg$ssa

  # -----
  #browser()
})
